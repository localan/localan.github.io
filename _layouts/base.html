<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.title | default: site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description | default: 'Philoshi Hacker — a minimalist, hacker-green static site.' }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a class="brand" href="/">Philoshi<span>_Hacker</span></a>
        <button class="nav-toggle" aria-expanded="false" aria-controls="site-nav" aria-label="Toggle navigation">Menu</button>
        <nav id="site-nav" class="nav" role="navigation">
          <a href="/index.html#about">About</a>
          <a href="/index.html#projects">Projects</a>
          <a href="/notes/">Notes</a>
          <a href="/tags/">Tags</a>
          <a href="/index.html#contact">Contact</a>
        </nav>
      </div>
    </header>

    <main>
      {{ content }}
    </main>

    <footer class="site-footer">
      <div class="container">
        <span>© <span id="year"></span> Philoshi Hacker</span>
        <span class="sep">•</span>
        <a href="#top">Back to top</a>
      </div>
    </footer>

    <script>
      // Update year
      document.getElementById('year').textContent = new Date().getFullYear();
      // Mobile nav toggle
      const toggle = document.querySelector('.nav-toggle');
      const nav = document.getElementById('site-nav');
      if (toggle && nav) {
        toggle.addEventListener('click', () => {
          const open = nav.classList.toggle('open');
          toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
      }
      // Build a small notes index for wiki-links
      window.NOTES_INDEX = [
        {% for n in site.notes %}
          { title: {{ n.title | jsonify }}, url: {{ n.url | jsonify }}, slug: {{ n.path | split: '/' | last | split: '.' | first | jsonify }} }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];

      // Replace [[Wiki Links]] in .note content with anchors using NOTES_INDEX
      (function() {
        const container = document.querySelector('.note');
        if (!container || !window.NOTES_INDEX) return;

        // Build lookup maps
        const bySlug = Object.create(null);
        const byTitle = Object.create(null);
        for (const it of window.NOTES_INDEX) {
          if (it.slug) bySlug[it.slug.toLowerCase()] = it.url;
          if (it.title) byTitle[it.title.toLowerCase()] = it.url;
        }

        // Walk child nodes except code/pre blocks
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
          acceptNode: (node) => {
            if (!node.nodeValue || node.nodeValue.indexOf('[[') === -1) return NodeFilter.FILTER_SKIP;
            // Skip if inside CODE or PRE
            let p = node.parentElement;
            while (p) { if (p.tagName === 'CODE' || p.tagName === 'PRE') return NodeFilter.FILTER_SKIP; p = p.parentElement; }
            return NodeFilter.FILTER_ACCEPT;
          }
        });

        const toProcess = [];
        while (walker.nextNode()) toProcess.push(walker.currentNode);

        for (const textNode of toProcess) {
          const text = textNode.nodeValue;
          const frag = document.createDocumentFragment();
          let idx = 0;
          const re = /\[\[([^\]]+)\]\]/g;
          let m;
          while ((m = re.exec(text))) {
            const before = text.slice(idx, m.index);
            if (before) frag.appendChild(document.createTextNode(before));
            const key = m[1].trim();
            const href = bySlug[key.toLowerCase()] || byTitle[key.toLowerCase()];
            const a = document.createElement('a');
            a.textContent = `[[${key}]]`;
            a.href = href || '#';
            if (!href) a.setAttribute('aria-invalid', 'true');
            frag.appendChild(a);
            idx = m.index + m[0].length;
          }
          const rest = text.slice(idx);
          if (rest) frag.appendChild(document.createTextNode(rest));
          textNode.parentNode.replaceChild(frag, textNode);
        }
      })();

      // Enhance code blocks: Copy for all, Run for JS
      (function() {
        // Live region for a11y feedback
        let live = document.getElementById('copy-live');
        if (!live) {
          live = document.createElement('div');
          live.id = 'copy-live';
          live.className = 'sr-only';
          live.setAttribute('aria-live', 'polite');
          document.body.appendChild(live);
        }

        async function copyTextFallback(text) {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); }
          finally { document.body.removeChild(ta); }
        }

        async function copyToClipboard(text) {
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(text);
            } else {
              await copyTextFallback(text);
            }
            return true;
          } catch {
            return false;
          }
        }

        const codeNodes = document.querySelectorAll('pre > code');
        for (const code of codeNodes) {
          const pre = code.parentElement;
          // Avoid double-wrapping
          if (pre.parentElement && pre.parentElement.classList.contains('code-block')) continue;
          const cls = code.className || '';
          const isJS = /language-(js|javascript)/.test(cls);
          // Language badge
          let lang = (cls.match(/language-([a-zA-Z0-9]+)/) || [,''])[1] || '';
          const map = { js: 'JS', javascript: 'JS', ts: 'TS', typescript: 'TS', html: 'HTML', css: 'CSS', json: 'JSON', bash: 'Bash', sh: 'Bash', shell: 'Bash', yaml: 'YAML', yml: 'YAML', md: 'MD', markdown: 'MD' };
          const badgeText = map[lang] || (lang ? lang.toUpperCase() : '');

          const wrap = document.createElement('div');
          wrap.className = 'code-block';
          pre.parentNode.insertBefore(wrap, pre);
          wrap.appendChild(pre);

          if (badgeText) {
            const b = document.createElement('span');
            b.className = 'code-badge';
            b.textContent = badgeText;
            wrap.appendChild(b);
          }

          const actions = document.createElement('div');
          actions.className = 'code-actions';
          const btnCopy = document.createElement('button');
          btnCopy.textContent = 'Copy';
          btnCopy.setAttribute('aria-label', 'Copy code to clipboard');
          actions.appendChild(btnCopy);

          let outPre = null;
          if (isJS) {
            const btnRun = document.createElement('button');
            btnRun.textContent = 'Run';
            btnRun.setAttribute('aria-label', 'Run this JavaScript code');
            actions.insertBefore(btnRun, btnCopy);
            // Optional Playground button for JS blocks marked as playground
            const wantsPlayground = code.classList.contains('playground') || /(^|\n)\s*\/\/\s*playground\b/.test(code.textContent) || /(^|\n)\s*\/\*\s*playground\s*\*\//.test(code.textContent);
            if (wantsPlayground) {
              const btnOpen = document.createElement('button');
              btnOpen.textContent = 'Open';
              btnOpen.setAttribute('aria-label', 'Open in Playground');
              actions.insertBefore(btnOpen, btnCopy);
              btnOpen.addEventListener('click', () => {
                const win = window.open('', '_blank');
                const src = `<!doctype html><html><head><meta charset="utf-8"><title>Playground</title><style>body{background:#0b0f10;color:#e6fff2;font-family:monospace;margin:0} .row{display:flex;gap:8px;padding:8px} textarea{flex:1;min-height:280px;background:#0a1310;color:#e6fff2;border:1px solid #142024;border-radius:8px;padding:8px} .tools{display:flex;gap:8px} button{background:rgba(28,255,135,.12);border:1px solid #142024;color:#e6fff2;border-radius:8px;padding:8px 10px;cursor:pointer} pre{white-space:pre-wrap;border:1px solid #142024;border-radius:8px;padding:8px;background:#0a1310;margin:8px}</style></head><body><div class='row'><textarea id='src'>${code.textContent.replace(/<\//g,'<\/')}</textarea><div class='tools'><button id='run'>Run ▶</button><button id='copy'>Copy</button></div></div><strong style='margin:0 8px'>Output</strong><pre id='out'></pre><script>const ta=document.getElementById('src');const out=document.getElementById('out');function wrap(c){return `<!doctype html><html><head><meta charset=\"utf-8\"></head><body><pre id=\"o\"></pre><script>const o=document.getElementById('o');const log=(...a)=>{o.textContent+=a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ')+'\\n'};console.log=log;console.error=(...a)=>{log('Error:',...a)};try{\\n${code.textContent.replace(/<\\//g,'<\\/')}\\n}catch(e){console.error(e.message||e)}<\\/script></body></html>`}document.getElementById('run').onclick=()=>{out.textContent='';const ifr=document.createElement('iframe');ifr.setAttribute('sandbox','allow-scripts');ifr.style.width='100%';ifr.style.border='1px solid #142024';ifr.style.borderRadius='8px';document.body.appendChild(ifr);ifr.srcdoc=wrap(ta.value)};document.getElementById('copy').onclick=async()=>{try{await navigator.clipboard.writeText(ta.value)}catch(e){const x=document.createElement('textarea');x.value=ta.value;document.body.appendChild(x);x.select();document.execCommand('copy');document.body.removeChild(x);}}</script></body></html>`;
                win.document.write(src);
                win.document.close();
              });
            }
            const output = document.createElement('div');
            output.className = 'code-output';
            output.innerHTML = '<strong>Output</strong><pre style="margin:6px 0 0"></pre>';
            outPre = output.querySelector('pre');
            wrap.appendChild(output);

            btnRun.addEventListener('click', () => {
              outPre.textContent = '';
              const iframe = document.createElement('iframe');
              iframe.setAttribute('sandbox', 'allow-scripts');
              iframe.style.width = '100%';
              iframe.style.border = '1px solid var(--border)';
              iframe.style.borderRadius = '8px';
              iframe.style.marginTop = '8px';
              const src = `<!doctype html><html><head><meta charset="utf-8"><style>body{background:#0b0f10;color:#e6fff2;font-family:monospace;padding:8px} pre{white-space:pre-wrap}</style></head><body><pre id="out"></pre><script>const out=document.getElementById('out');const log=(...a)=>{out.textContent+=a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ')+'\n'};console.log=log;console.error=(...a)=>{log('Error:',...a)};try{\n${code.textContent.replace(/<\//g,'<\/')}\n}catch(e){console.error(e.message||e)}</script></body></html>`;
              const old = wrap.querySelector('iframe');
              if (old) old.remove();
              wrap.appendChild(iframe);
              iframe.srcdoc = src;
            });
          }

          wrap.appendChild(actions);

          btnCopy.addEventListener('click', async () => {
            const ok = await copyToClipboard(code.textContent);
            const old = btnCopy.textContent;
            btnCopy.textContent = ok ? 'Copied' : 'Failed';
            live.textContent = ok ? 'Code copied to clipboard' : 'Copy failed';
            setTimeout(() => { btnCopy.textContent = old; live.textContent = ''; }, 1500);
          });
        }
      })();

      // Inline code copy buttons (for short inline code)
      (function(){
        function eligible(el){
          if (!el || !el.textContent) return false;
          if (el.closest('pre')) return false;
          const t=el.textContent.trim();
          return t.length>0 && t.length<=120;
        }
        async function copyFallback(text){
          const ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly',''); ta.style.position='absolute'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); try{document.execCommand('copy')}finally{document.body.removeChild(ta)}
        }
        async function copy(text){
          try{ if(navigator.clipboard&&window.isSecureContext){await navigator.clipboard.writeText(text)} else {await copyFallback(text)} return true }catch{ return false }
        }
        const nodes=document.querySelectorAll('code');
        for(const c of nodes){
          if(!eligible(c)) continue;
          if(c.dataset.copyAttached==='1') continue;
          c.dataset.copyAttached='1';
          const btn=document.createElement('button');
          btn.className='inline-copy-btn'; btn.type='button'; btn.textContent='Copy'; btn.setAttribute('aria-label','Copy inline code');
          btn.addEventListener('click', async (e)=>{ e.stopPropagation(); const ok=await copy(c.textContent); const old=btn.textContent; btn.textContent= ok?'Copied':'Failed'; setTimeout(()=>btn.textContent=old,1200); });
          if(c.nextSibling) c.parentNode.insertBefore(btn,c.nextSibling); else c.parentNode.appendChild(btn);
        }
      })();
    </script>
  </body>
  </html>
